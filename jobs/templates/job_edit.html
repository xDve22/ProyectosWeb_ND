{% extends "base.html" %}
{% block title %}Editar {{ job.title }}{% endblock %}

{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static 'jobs/job_edit.css' %}">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
{% endblock %}

{% block content %}
<section class="job-edit">
  <article class="job-edit__card">
    <h2 class="job-edit__title">Edit Job</h2>

    <form method="post" enctype="multipart/form-data" class="job-edit__form">
      {% csrf_token %}

      <div class="form-group form-group--full">
        <label for="id_logo" class="form-group__label">Company logo</label>
        <div class="job-edit__logo-section">
          <div class="job-edit__logo-preview">
            {% if job.company.logo %}
              <img src="{{ job.company.logo }}" alt="{{ job.company.name }}" class="job-edit__logo-img" id="logo-preview">
            {% else %}
              <img src="{% static 'img/default.png' %}" alt="Default logo" class="job-edit__logo-img" id="logo-preview">
            {% endif %}
          </div>
          <div class="job-edit__file-info">
            <label for="id_logo" class="job-edit__file-btn">Select file</label>
            <span class="job-edit__file-name" id="file-name">Ningún archivo seleccionado</span>
          </div>
          {{ form.logo }}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="id_company" class="form-group__label">Company</label>
          {{ form.company }}
        </div>
        <div class="form-group">
          <label for="id_title" class="form-group__label">Job Title</label>
          {{ form.title }}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="id_location" class="form-group__label">Location</label>
          {{ form.location }}
        </div>
        <div class="form-group">
          <label for="id_employment_type" class="form-group__label">Employment Type</label>
          {{ form.employment_type }}
        </div>
      </div>

      <div class="form-group form-group--full">
        <label for="quill-editor" class="form-group__label">Job Description</label>
        <div class="job-edit__editor">
          <div id="quill-editor" class="job-edit__editor-content"></div>
        </div>
        {{ form.description }}
      </div>

      <div class="job-edit__actions">
        <button type="submit" class="btn-save">Save</button>
        <a href="{% url 'jobs:job_detail' job.pk %}" class="btn-cancel">Cancel</a>
      </div>
    </form>
  </article>
</section>

{{ job.description|json_script:"jobDesc" }}

<script>
  const quill = new Quill('#quill-editor', { theme: 'snow' });

  const existingDesc = JSON.parse(document.getElementById('jobDesc').textContent);
  quill.root.innerHTML = existingDesc;

  const form = document.querySelector('form');
  form.onsubmit = function() {
    document.querySelector('input[name="description"]').value = quill.root.innerHTML;
  };

  const fileInput = document.getElementById('id_logo');
  const fileName = document.getElementById('file-name');
  const logoPreview = document.getElementById('logo-preview');

  fileInput.addEventListener('change', function(e) {
    if (this.files && this.files[0]) {
      fileName.textContent = this.files[0].name;

      const reader = new FileReader();
      reader.onload = function(e) {
        logoPreview.src = e.target.result;
      };
      reader.readAsDataURL(this.files[0]);
    } else {
      fileName.textContent = 'Ningún archivo seleccionado';
    }
  });
</script>
{% endblock %}
